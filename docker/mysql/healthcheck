
#!/bin/bash
set -eo pipefail

INITILIZED=/bitnami/mysql/.mysql_initialized

if [ ! -f "$INITILIZED" ]; then
  exit 1
fi

host="$(hostname --ip-address || echo '127.0.0.1')"
user="${MYSQL_USER:-user}"
password="${MYSQL_PASSWORD:-secret}"
export MYSQL_PWD="${MYSQL_PASSWORD:-$MYSQL_ROOT_PASSWORD}"

arguments=(
	--host=$host
	--user="$user"
	--password="$password"
	--silent
)

if [ "$MYSQL_RANDOM_ROOT_PASSWORD" ] && [ -z "$MYSQL_USER" ] && [ -z "$MYSQL_PASSWORD" ]; then
	# there's no way we can guess what the random MySQL password was
	echo >&2 'healthcheck error: cannot determine random root password (and MYSQL_USER and MYSQL_PASSWORD were not set)'
	exit 1
fi

if command -v mysqladmin &> /dev/null; then
	if mysqladmin "${arguments[@]}" ping > /dev/null; then
		exit 0
	fi
else
	if select="$(echo 'SELECT 1' | mysql "${arguments[@]}")" && [ "$select" = '1' ]; then
		exit 0
	fi
fi

exit 1
